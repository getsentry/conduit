# Ignored by docker compose, used by devservices
x-sentry-service-config:
  version: 0.1
  service_name: conduit
  dependencies:
    redis-cluster:
      description: Conduit's redis cluster (broker)
    gateway:
      description: Conduit gateway service
    publish:
      description: Conduit publish service
    cleanup:
      description: Conduit cleanup service
  modes:
    default: [redis-cluster]
    containerized: [redis-cluster, gateway, publish, cleanup]

x-programs:
  devserver:
    command: sh -c 'cargo run --bin gateway & cargo run --bin publish'

services:
  gateway:
    image: ghcr.io/getsentry/conduit-gateway:dev
    environment:
      GATEWAY_PORT: ${GATEWAY_PORT:-8000}
      REDIS_URL: ${REDIS_URL:-redis://redis:7000}
      JWT_ISSUER: ${JWT_ISSUER:-}
      JWT_AUDIENCE: ${JWT_AUDIENCE:-}
      JWT_PUBLIC_KEY: ${JWT_PUBLIC_KEY:-}
    ports:
      - 127.0.0.1:8000:8000
    networks:
      - devservices
    labels:
      - orchestrator=devservices
    healthcheck:
      test: curl -f http://127.0.0.1:8000/healthz
      interval: 5s
      timeout: 5s
      retries: 3
    restart: unless-stopped
  publish:
    image: ghcr.io/getsentry/conduit-publish:dev
    environment:
      PUBLISH_PORT: ${PUBLISH_PORT:-8001}
      REDIS_URL: ${REDIS_URL:-redis://redis:7000}
    ports:
      - 127.0.0.1:8001:8001
    networks:
      - devservices
    labels:
      - orchestrator=devservices
    healthcheck:
      test: curl -f http://127.0.0.1:8001/healthz
      interval: 5s
      timeout: 5s
      retries: 3
    restart: unless-stopped
  cleanup:
    image: ghcr.io/getsentry/conduit-cleanup:dev
    environment:
      CLEANUP_PORT: ${CLEANUP_PORT:-8002}
      REDIS_URL: ${REDIS_URL:-redis://redis:7000}
    ports:
      - 127.0.0.1:8002:8002
    networks:
      - devservices
    labels:
      - orchestrator=devservices
    healthcheck:
      test: curl -f http://127.0.0.1:8002/healthz
      interval: 5s
      timeout: 5s
      retries: 3
    restart: unless-stopped
  redis-cluster:
    image: ghcr.io/getsentry/docker-redis-cluster:7.0.10
    ports:
      - '127.0.0.1:7000:7000'
      - '127.0.0.1:7001:7001'
      - '127.0.0.1:7002:7002'
      - '127.0.0.1:7003:7003'
      - '127.0.0.1:7004:7004'
      - '127.0.0.1:7005:7005'
    networks:
      - devservices
    environment:
      - IP=0.0.0.0
    labels:
      - orchestrator=devservices

networks:
  devservices:
    name: devservices
    external: true
